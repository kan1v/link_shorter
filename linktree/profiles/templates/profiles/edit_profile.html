{% extends 'main/base.html' %}
{% block title %}Редагування профілю{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-10 px-4">
  <h1 class="text-3xl font-bold mb-6">Редагування публічного профілю</h1>

  <form method="POST" class="space-y-8">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- Общие настройки -->
    <div class="grid grid-cols-2 gap-4">
      <div>
        {{ form.background_color.label_tag }}
        {{ form.background_color }}
      </div>
      <div>
        {{ form.button_style.label_tag }}
        {{ form.button_style }}
      </div>
    </div>

    <!-- Соцмережі -->
    <h2 class="text-2xl font-semibold mt-8 mb-4">Соцмережі</h2>
    {{ social_formset.management_form }}
    <div id="social-container" class="space-y-4">
      {% for form in social_formset %}
        <div class="form-row bg-gray-50 border rounded-xl p-4 shadow-sm flex flex-col md:flex-row md:items-center md:justify-between">
          {# скрытые поля (id, DELETE и т.п.) обязательно рендерить #}
          <div class="hidden">
            {% for hidden in form.hidden_fields %}
              {{ hidden }}
            {% endfor %}
          </div>

          <div class="w-full md:w-2/3 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              {{ form.name.label_tag }} 
              {{ form.name }}
            </div>
            <div>
              {{ form.url.label_tag }} 
              {{ form.url }}
            </div>
          </div>

          <div class="mt-3 md:mt-0 md:ml-4">
            <button type="button" class="delete-btn inline-flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg">
              Видалити
            </button>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="mt-2">
      <button type="button" id="add-social" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">+ Додати соцмережу</button>
    </div>

    {# пустая форма-шаблон, которую будем клонировать #}
    <div id="sociallink_set-empty" class="hidden">
      {{ social_formset.empty_form.as_p }}
    </div>

    <!-- Кнопки -->
    <h2 class="text-2xl font-semibold mt-8 mb-4">Кнопки</h2>
    {{ button_formset.management_form }}
    <div id="button-container" class="space-y-4">
      {% for form in button_formset %}
        <div class="form-row bg-gray-50 border rounded-xl p-4 shadow-sm flex flex-col md:flex-row md:items-center md:justify-between">
          <div class="hidden">
            {% for hidden in form.hidden_fields %}
              {{ hidden }}
            {% endfor %}
          </div>

          <div class="w-full md:w-2/3 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              {{ form.title.label_tag }}
              {{ form.title }}
            </div>
            <div>
              {{ form.url.label_tag }}
              {{ form.url }}
            </div>
          </div>

          <div class="mt-3 md:mt-0 md:ml-4">
            <button type="button" class="delete-btn inline-flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg">
              Видалити
            </button>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="mt-2">
      <button type="button" id="add-button" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">+ Додати кнопку</button>
    </div>

    <div id="custombutton_set-empty" class="hidden">
      {{ button_formset.empty_form.as_p }}
    </div>

    <div class="pt-6">
      <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg">Зберегти зміни</button>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  function addForm(prefix, containerId, emptyId) {
    const totalInput = document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);
    if (!totalInput) return;
    const formCount = parseInt(totalInput.value, 10);
    const container = document.getElementById(containerId);
    const templateWrapper = document.getElementById(emptyId);
    if (!templateWrapper) return;
    // empty_form.as_p возвращает <p> .. поля .. </p> — используем её
    let newFormHtml = templateWrapper.innerHTML.replace(/__prefix__/g, formCount);
    // Создаём элемент для обёртки с такими же классами, как и у существующих
    const wrapper = document.createElement('div');
    wrapper.className = 'form-row bg-gray-50 border rounded-xl p-4 shadow-sm flex flex-col md:flex-row md:items-center md:justify-between mt-2';
    wrapper.innerHTML = newFormHtml;
    container.appendChild(wrapper);
    totalInput.value = formCount + 1;
  }

  document.getElementById('add-social')?.addEventListener('click', function() {
    addForm('sociallink_set', 'social-container', 'sociallink_set-empty');
  });

  document.getElementById('add-button')?.addEventListener('click', function() {
    addForm('custombutton_set', 'button-container', 'custombutton_set-empty');
  });

  // Делит кнопку: помечаем DELETE и скрываем форму
  document.addEventListener('click', function(e) {
    if (e.target.closest('.delete-btn')) {
      const btn = e.target.closest('.delete-btn');
      const formRow = btn.closest('.form-row');
      if (!formRow) return;
      // найдем поле DELETE (input name заканчивается на -DELETE)
      const deleteInput = formRow.querySelector('input[name$="-DELETE"]');
      if (deleteInput) {
        deleteInput.checked = true;
      } else {
        // если формы добавлена динамически без hidden DELETE, можно удалить узел
        // но лучше отметить для сервера — так что ничего не делаем
      }
      formRow.style.display = 'none';
    }
  });
});
</script>
{% endblock %}
